@page
@model LoCoMPro_LV.Pages.Stores.CreateModel
@{
    ViewData["Title"] = "Agregar Establecimiento";
}
<div class="add_store">
    <h1 class="title_add">Agregar Establecimiento</h1>
    <form method="post">
        <input type="text" asp-for="Store.NameStore" class="form-control" placeholder="Nombre del Establecimiento" required/>
        <div class="map" id="map"></div>
        <div id="marker-info" style="display: none;">
            <input type="hidden" step="0.0001" id="latitude" asp-for="Store.Latitude" />
            <input type="hidden" step="0.0001" id="longitude" asp-for="Store.Longitude" />
            <input type="text" id="NameProvince" asp-for="Store.NameProvince" disabled />
            <input type="text" id="NameCanton" asp-for="Store.NameCanton" disabled/>
        </div>
        <button type="submit" class="btn btn-primary">Guardar</button>
    </form>
</div>

<script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.2/dist/leaflet.css" />
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var map = L.map('map', {
            minZoom: 8,
            maxZoom: 17,
            dragging: true
        }).setView([9.9281, -84.0907], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 18
        }).addTo(map);

        var costaRicaBounds = L.latLngBounds(L.latLng(8.032, -85.950), L.latLng(11.217, -82.555));
        map.setMaxBounds(costaRicaBounds);

        map.on('drag', function () {
            if (!costaRicaBounds.contains(map.getBounds())) {
                map.panInsideBounds(costaRicaBounds, { animate: true });
            }
        });

        var marker = L.marker([9.9281, -84.0907], { draggable: true }).addTo(map);

        marker.on('dragend', function (e) {
            var latlng = e.target.getLatLng();

            document.getElementById('latitude').value = latlng.lat.toFixed(4);
            document.getElementById('longitude').value = latlng.lng.toFixed(4);

            document.getElementById('marker-info').style.display = 'block';

            var lat = latlng.lat.toFixed(4);
            var lng = latlng.lng.toFixed(4);
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
                .then(response => response.json())
                .then(data => {
                    var address = data.address || {};
                    var province = address.province || 'N/A';
                    var canton = address.county || 'N/A';
                    if (canton == "N/A") { 
                        canton = address.region || 'N/A';
                    }
                    province = cleanText(province);
                    canton = cleanText(canton);


                    document.getElementById('NameProvince').value = province;
                    document.getElementById('NameCanton').value = canton;
                })
                .catch(error => {
                    console.error('Error en la solicitud de geocodificación inversa', error);
                });
        });
        function cleanText(text) {
            var words = text.split(" ");
            var filteredWords = words.filter(word => word !== "Provincia" && word !== "Cantón");
            var cleanedText = filteredWords.join(" ");
            return cleanedText;
        }
    });
</script>

<script type="text/javascript">
    $(function () {
        var data = @Html.Raw(Json.Serialize(Model.Stores));
        $("#Store").autocomplete({
            source: data,
            minLength: 1
        });
    });
</script>
